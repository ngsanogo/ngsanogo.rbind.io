<div class="search-container">
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Search..." aria-label="Search" accesskey="/">
        <div id="search-results" class="search-results" role="region" aria-live="polite"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let searchIndex = null;

    // Keyboard shortcut: Press '/' to focus search
    document.addEventListener('keydown', function(e) {
        if (e.key === '/' && document.activeElement !== searchInput) {
            e.preventDefault();
            searchInput.focus();
        }
        if (e.key === 'Escape') {
            searchResults.style.display = 'none';
            searchInput.blur();
        }
    });

    // Charger l'index de recherche
    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            searchIndex = data;
        })
        .catch(error => console.error('Error loading search index:', error));

    // Simple fuzzy matching function
    function fuzzyMatch(text, query) {
        text = text.toLowerCase();
        query = query.toLowerCase();
        let queryIndex = 0;
        
        for (let i = 0; i < text.length && queryIndex < query.length; i++) {
            if (text[i] === query[queryIndex]) {
                queryIndex++;
            }
        }
        
        return queryIndex === query.length;
    }

    // Enhanced search function
    function performSearch(query) {
        if (!searchIndex) {
            searchResults.innerHTML = '<p class="search-loading">Loading search index...</p>';
            return;
        }
        
        const results = searchIndex.filter(item => {
            const searchContent = (item.title + ' ' + item.content + ' ' + (item.tags || []).join(' ')).toLowerCase();
            const queryLower = query.toLowerCase();
            
            // Exact match first
            if (searchContent.includes(queryLower)) {
                item.score = 100;
                return true;
            }
            
            // Fuzzy match as fallback
            if (fuzzyMatch(searchContent, queryLower)) {
                item.score = 50;
                return true;
            }
            
            return false;
        }).sort((a, b) => b.score - a.score).slice(0, 10); // Limit to top 10 results

        displayResults(results, query);
    }

    // Display results with highlighting
    function displayResults(results, query) {
        if (results.length === 0) {
            searchResults.innerHTML = '<p class="search-no-results">No results found for "' + query + '"</p>';
            return;
        }

        const html = '<div class="search-count">' + results.length + ' result' + (results.length > 1 ? 's' : '') + '</div>' +
            results.map(item => {
                const excerpt = item.description || item.content.substring(0, 150);
                const tags = item.tags ? '<div class="search-tags">' + item.tags.slice(0, 3).map(tag => '<span class="tag">' + tag + '</span>').join('') + '</div>' : '';
                
                return `
                <div class="search-result">
                    <h3><a href="${item.permalink}">${item.title}</a></h3>
                    <p>${excerpt}...</p>
                    ${tags}
                    <span class="search-date">${item.date}</span>
                </div>
            `;
        }).join('');

        searchResults.innerHTML = html;
    }

    // Search event handler
    let debounceTimer;
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = this.value.trim();
            if (query.length > 2) {
                performSearch(query);
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }, 300);
    });

    // Close results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            searchResults.style.display = 'none';
        }
    });
});
</script> 